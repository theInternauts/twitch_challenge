<!DOCTYPE html>
<html>
<head>
	<title>Sony Challenge&mdash;by: Christopher "Cricket" Wallace</title>
</head>
<style>
	body {
		background-color: #ddd;
	}

	#wrapper {
		border-radius: 4px;
		max-width: 80%;
		height: 100%;
		margin: 10px auto;
		background-color: #FFF;
	}

	.panel {
		padding: 2em;
	}

	#search-panel {
		padding: 20px 10px 10px 10px;
		border-bottom: 1px solid #F00;
	}
	#results-count {
		display: inline-block;
		float: left;
	}
	#results-page-controls {
		display: inline-block;
		float: right;
	}
	#results-list {
		padding-left: 0px;
		list-style: none;
		margin: 3em 0em;
	}

	#results-list li {
		margin-bottom: 1.5em;
	}

	#results-list div:first-of-type {}
	#results-list div:last-of-type {}
	
	#results-list div img {
		width: 150px;
		margin: 0em 1em 1em 0em;
		/*float: left;*/
	}
	#results-list p {}
	#results-list p:first-of-type {
		font-weight: bold;
		font-size: 1.5em;
		margin-bottom: 0.5em;
	}
	#results-list p span { font-style: italic; }

	.msg-error {
		color: #F00;
		font-weight: bold;
		font-style: italic;
		padding-left: 1em;
	}

</style>
<script type="text/javascript" src="fakeData.js"></script>
<script type="text/javascript">
	function KrakenSearchApp(id, options){
		this.root = document.getElementById(id)
		this.baseURL = 'https://api.twitch.tv/kraken/search/streams' || options.baseURL
		this.init()
	}

	KrakenSearchApp.prototype.init = function(){
		console.log("init")
		this.buildSearchBar()
		this.buildResultsPanelContainer();
	}
	
	KrakenSearchApp.prototype.buildSearchBar = function(){
		var textFragment = '<input id="input-search" type="text" placeholder="Search query..." /><input type="submit" value="Search" />'		
		var HTMLfragment = this.UtilCreateFragment('DIV', 'search-panel', 'panel')
		HTMLfragment.childNodes[0].innerHTML = textFragment
		this.root.appendChild(HTMLfragment)

		this.setSearchListeners()
	}

	KrakenSearchApp.prototype.setSearchListeners = function(){
		document.getElementById('input-search').addEventListener('keyup', this.searchHandler.bind(this), true)
	}

	KrakenSearchApp.prototype.searchHandler = function(event){
		this.searchAPI(event.target.value)	
	}

	KrakenSearchApp.prototype.searchAPI = function(term){
		var baseURL = 'https://api.twitch.tv/kraken/search/streams'
		var queryURL = this.baseURL + '?q=' + encodeURI('"' + term + '"')
		var server = new AsyncModule()
		var config = {
			scope: this,
			callback: this.displaySearchResults,
			arguments: ['results-list'],
			onError: this.AsyncErrorHandler
		}
		
		//Asyc call to twitch with 'term'
		server.load(queryURL, config)
	}

	KrakenSearchApp.prototype.displaySearchResults = function(parentId, data){
		var parent = document.getElementById(parentId)
		this.UtilEmptyNode(parent)
		data.streams.forEach(function(stream){
			var textFragment = '<div><img src="' + stream.channel.logo + '" /></div><div><p>' + stream.channel.status + '</p><p><span>' + stream.game + '</span> - <span>' + stream.viewers + ' viewers</span></p></div>'
			var HTMLfragment = document.createDocumentFragment();
			HTMLfragment.appendChild(document.createElement('LI'))
			HTMLfragment.childNodes[0].innerHTML = textFragment
			parent.appendChild(HTMLfragment)
		})
		
		this.updateResultsCount(data._total)
	}

	KrakenSearchApp.prototype.updateResultsCount = function(newCount){
		var counterDisplayNode = document.getElementById('results-count').childNodes[1]
		counterDisplayNode.innerHTML = newCount
	}

	KrakenSearchApp.prototype.UtilCreateFragment = function(elementTag, nodeId, nodeClass){
		//currently this only supports setting an ID attribute and/or a single class attribute
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement(elementTag))
		if(nodeClass){
			var attrClass = document.createAttribute("class")
			attrClass.value = nodeClass
			HTMLfragment.childNodes[0].setAttributeNode(attrClass)
		}
		if(nodeId){
			var attrId = document.createAttribute("id")
			attrId.value = nodeId			
			HTMLfragment.childNodes[0].setAttributeNode(attrId)
		}

		return HTMLfragment
	}

	KrakenSearchApp.prototype.UtilEmptyNode = function(node){
		while (node.hasChildNodes()) {
		    node.removeChild(node.lastChild);
		}
	}

	KrakenSearchApp.prototype.buildResultsPanelContainer = function(){	
		var HTMLfragment = this.UtilCreateFragment('DIV', 'results-panel', 'panel')			
		this.root.appendChild(HTMLfragment)
		this.buildResultsCountTemplate('results-panel')
		//this.buildResultsPageControlsTemplate('results-panel')  //I can't properly implment this until I deal with cross-origin security
		this.buildResultsListTemplate('results-panel')
	}

	KrakenSearchApp.prototype.buildResultsCountTemplate = function(parentId){
		var textFragment = '<span>Total results: </span><span>0</span>'		
		var parent = document.getElementById(parentId)		
		var HTMLfragment = this.UtilCreateFragment('DIV', 'results-count')		
		HTMLfragment.childNodes[0].innerHTML = textFragment
		parent.appendChild(HTMLfragment)
	}

	KrakenSearchApp.prototype.buildResultsPageControlsTemplate = function(parentId, currentPage, maxPage, interval){
		var textFragment = '<a href="#"><span>&#8676;</span></a><a href="#"><span>&#8678;</span></a><span>1 / 1</span><a href="#"><span>&#8680;</span></a><a href="#"><span>&#8677;</span></a>'
		var parent = document.getElementById(parentId)
		var HTMLfragment = this.UtilCreateFragment('DIV', 'results-page-controls')
		HTMLfragment.childNodes[0].innerHTML = textFragment
		parent.appendChild(HTMLfragment)
	}

	KrakenSearchApp.prototype.buildResultsListTemplate = function(parentId){
		var parent = document.getElementById(parentId)
		var HTMLfragment = this.UtilCreateFragment('UL', 'results-list')
		parent.appendChild(HTMLfragment)
	}

	KrakenSearchApp.prototype.AsyncErrorHandler = function(errorMessage){
		var HTMLfragment = this.UtilCreateFragment('DIV', 'msg-async', 'msg-error')
		var newNode = HTMLfragment.childNodes[0]
		newNode.innerHTML = '(Click to remove) Error: '+ errorMessage
		this.root.appendChild(HTMLfragment)
		this.root.insertBefore(newNode, this.root.childNodes[0])
		var removalHandler = function(event){			
			event.preventDefault()
			this.removeEventListener('click', removalHandler, false);
			this.remove()
		}
		newNode.addEventListener('click', removalHandler, false)
	}

//AsyncModule
	AsyncModule = function(){
		var xhr, response, responseText

		function init(){
			xhr = new XMLHttpRequest()			
		}

		function UtilCreateFragment(elementTag, nodeId, nodeClass){
			//currently this only supports setting an ID attribute and/or a single class attribute
			var HTMLfragment = document.createDocumentFragment();
			HTMLfragment.appendChild(document.createElement(elementTag))
			if(nodeClass){
				var attrClass = document.createAttribute("class")
				attrClass.value = nodeClass
				HTMLfragment.childNodes[0].setAttributeNode(attrClass)
			}
			if(nodeId){
				var attrId = document.createAttribute("id")
				attrId.value = nodeId			
				HTMLfragment.childNodes[0].setAttributeNode(attrId)
			}

			return HTMLfragment
		}

		function handlerCustomJSONPEvent(options){
			var finalHandler = function(event){
				response = event
				responseText = event.detail.JSONPdata
				if (options.callback != null && options.scope != null){
					options.callback.call(options.scope, responseText)
				}
				//these next two lines may casue issues when there are multiple instances of the this module making JSONP requests
				//delete window.handlerAsyncModule //potential RACE CONDITION if multiple events fired quickly, as well
				window.removeEventListener('JSONP-LOADED', finalHandler, false)
			}

			//the actual handler is finalHandler
			return finalHandler
		}

		function loadJSONP(url, options){
			//attaching an event listener to the global scope to handle a custom event			
			window.addEventListener('JSONP-LOADED', handlerCustomJSONPEvent(options), false)

			//dynamically create global callback to handle the JSONP script tag load 
			window.handlerAsyncModule = function(data){
				var AsyncModuleUID = uid				
				var myJSONPEvent

				if (window.CustomEvent) {
					myJSONPEvent = new CustomEvent('JSONP-LOADED', { 'detail': { 'JSONPdata': data, 'AsyncModuleUID': AsyncModuleUID }})
					window.dispatchEvent(myJSONPEvent);
				}
			}
						
			//create a script tag to load the JSONP url (then destroy it)			
			var newUrl = url.concat('&callback=handlerAsyncModule')
			var uid = "AsyncModuleObject" + Date.now()									
			var HTMLfragment = UtilCreateFragment('SCRIPT', uid)
			var loader = HTMLfragment.childNodes[0]
			loader.src = newUrl
			loader.type = 'text/javascript'
			document.getElementsByTagName('head')[0].appendChild(HTMLfragment)
			loader != null ? loader.remove() : null
			return uid
		}

		function STUBload(url, options){
			response = 200
        	responseText = STUBDATA
			if(options.callback){
				options.arguments ? options.arguments.push(STUBDATA) : null
				options.callback.apply(options.scope, options.arguments)
			} else {
				return responseText
			}
		}

		function get(url){
			xhr.open('get', url)
			 
			xhr.onreadystatechange = function(){
			    if(xhr.readyState === 4){
			        if(xhr.status === 200){
			        	console.log("yes: ", xhr.responseText)
			        	response = xhr.status
			        	responseText = xhr.responseText
			        	return xhr.responseText
			        } else {
			            alert('Error: '+ xhr.status)
			        }
			    }
			}
			 
			xhr.send(null)	
		}


		function load(url, options){
			xhr.open('get', url)
			 
			xhr.onreadystatechange = function(){
			    if(xhr.readyState === 4){
			        if(xhr.status === 200){
			        	if(options.callback){
							options.arguments ? options.arguments.push(JSON.parse(xhr.responseText)) : null
							options.callback.apply(options.scope, options.arguments)
						} else {
							console.log(xhr.responseText)
						}			      
						response = xhr.status
			        	responseText = xhr.responseText
						//not sure about this line  	
						return xhr.responseText
			        } else {
			        	response = xhr.status
			        	responseText = ""
			        	if(options.onError){
							options.onError.apply(options.scope, [xhr.status])
						} else {							
				            alert('Error: '+ xhr.status)
						}
			        }
			    }
			}
			 
			xhr.send(null)				
		}

		function getResponse(){
			return response
		}

		function getResponseText(){ 
			return responseText
		}

		init()

		return {
			load: STUBload,
			loadJSONP: loadJSONP,
			getResponse: getResponse, 
			getResponseText: getResponseText,
			get: get
		}
	}
	
	window.onload = function(){
		new KrakenSearchApp('wrapper')
		// app = new KrakenSearchApp('wrapper')
	}
</script>
<body id="root">
 <div id="wrapper">
 	
 </div>
</body>
</html>