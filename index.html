<!DOCTYPE html>
<html>
<head>
	<title>Sony Challenge&mdash;by: Christopher "Cricket" Wallace</title>
</head>
<style>
	body {
		background-color: #ddd;
	}

	#wrapper {
		border-radius: 4px;
		max-width: 80%;
		height: 100%;
		margin: 10px auto;
		background-color: #FFF;
	}

	.panel {
		padding: 2em;
	}

	#search-panel {
		padding: 20px 10px 10px 10px;
		border-bottom: 1px solid #F00;
	}
	#results-count {
		display: inline-block;
		float: left;
	}
	#results-page-controls {
		display: inline-block;
		float: right;
	}
	#results-list {
		padding-left: 0px;
		list-style: none;
		margin: 3em 0em;
	}

	#results-list li {
		margin-bottom: 1.5em;
	}

	#results-list div:first-of-type {
		/*width: 150px;*/
		/*float: left;*/
	}
	#results-list div:last-of-type {
	/*	width: 150px;
		height: 100%;*/
		/*float: right;*/
	}
	
	#results-list div img {
		width: 150px;
		margin: 0em 1em 1em 0em;
		/*float: left;*/
	}
	#results-list p {}
	#results-list p:first-of-type {
		font-weight: bold;
		font-size: 1.5em;
		margin-bottom: 0.5em;
	}
	#results-list p span { font-style: italic; }

</style>
<script type="text/javascript" src="fakeData.js"></script>
<script type="text/javascript">
	function KrakenSearchApp(id){
		this.root = document.getElementById(id)
		this.init()		
	}

	KrakenSearchApp.prototype.init = function(){
		console.log("init")
		this.buildSearchBar()
		this.buildResultsPanelContainer();
	}
	
	KrakenSearchApp.prototype.buildSearchBar = function(){
		var textFragment = '<input id="input-search" type="text" placeholder="Search query..." /><input type="submit" value="Search" />'
		
		var attrClass = document.createAttribute("class")
		attrClass.value = "panel"
		var attrId = document.createAttribute("id")
		attrId.value = "search-panel"
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement('DIV'))
		HTMLfragment.childNodes[0].setAttributeNode(attrId)
		HTMLfragment.childNodes[0].setAttributeNode(attrClass)
		
		HTMLfragment.childNodes[0].innerHTML = textFragment
		this.root.appendChild(HTMLfragment)

		this.setSearchListeners()
	}

	KrakenSearchApp.prototype.setSearchListeners = function(){
		document.getElementById('input-search').addEventListener('keyup', this.searchHandler, true)
	}

	KrakenSearchApp.prototype.searchHandler = function(event){
		KrakenSearchApp.prototype.searchAPI.call(KrakenSearchApp, event.target.value)		
	}

	KrakenSearchApp.prototype.searchAPI = function(term){
		var baseURL = 'https://api.twitch.tv/kraken/search/streams'
		var queryURL = baseURL + '?q="' + encodeURI(term) + '"'
		console.log(queryURL)
		var server = new AsyncModule()
		/*the following object literal is not good becasue I'm explictly referencing a instance 
		of the KrakenSearchApp() at the 'scope' key. This is a hack/patch to get the demo to work. This app is MEGA brittle now and I don't know how 
		to fix it */
		var config = {
			scope: app,
			callback: KrakenSearchApp.prototype.displaySearchResults,
			arguments: ['results-list']
		}
		
		//Asyc call to twitch with 'term'
		server.load(queryURL, config)
	}

	KrakenSearchApp.prototype.displaySearchResults = function(parentId, data){
		console.log('pid: ', parentId, 'data: ', data)
		//loop through data and add a 'li' node to the parent for each stream object
		var parent = document.getElementById(parentId)
		//parent.innerHTML = null   
		//Need to implment a function to empty the DOM node
		while (parent.hasChildren) {
		    myNode.removeChild(myNode.lastChild);
		}
		data.streams.forEach(function(stream){
			var textFragment = '<div><img src="' + stream.channel.logo+ '" /></div><div><p>' + stream.channel.status + '</p><p><span>' + stream.game + '</span> - <span>' + stream.viewers + ' viewers</span></p></div>'
			var HTMLfragment = document.createDocumentFragment();
			HTMLfragment.appendChild(document.createElement('LI'))
			HTMLfragment.childNodes[0].innerHTML = textFragment
			parent.appendChild(HTMLfragment)
		})
		
		this.updateResultsCount(data._total)
	}

	KrakenSearchApp.prototype.updateResultsCount = function(newCount){
		var counterDisplayNode = document.getElementById('results-count').childNodes[1]
		counterDisplayNode.innerHTML = newCount
	}

	KrakenSearchApp.prototype.buildResultsPanelContainer = function(){
		//var textFragment = '<input id="input-search" type="text" placeholder="Search query..." /><input type="submit" value="Search" />'
		
		var attrClass = document.createAttribute("class")
		attrClass.value = "panel"
		var attrId = document.createAttribute("id")
		attrId.value = "results-panel"
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement('DIV'))
		HTMLfragment.childNodes[0].setAttributeNode(attrId)
		HTMLfragment.childNodes[0].setAttributeNode(attrClass)
		
		//HTMLfragment.childNodes[0].innerHTML = textFragment
		this.root.appendChild(HTMLfragment)
		this.buildResultsCountTemplate(attrId.value)
		this.buildResultsPageControlsTemplate(attrId.value)
		this.buildResultsListTemplate(attrId.value)
	}

	KrakenSearchApp.prototype.buildResultsCountTemplate = function(parentId){
		var textFragment = '<span>Total results: </span><span>123</span>'
		
		var parent = document.getElementById(parentId)
		var attrId = document.createAttribute("id")
		attrId.value = "results-count"
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement('DIV'))
		HTMLfragment.childNodes[0].setAttributeNode(attrId)
		
		HTMLfragment.childNodes[0].innerHTML = textFragment
		parent.appendChild(HTMLfragment)
	}

	KrakenSearchApp.prototype.buildResultsPageControlsTemplate = function(parentId, currentPage, maxPage, interval){
		var textFragment = '<a href="#"><span>&#8676;</span></a><a href="#"><span>&#8678;</span></a><span>1/20</span><a href="#"><span>&#8680;</span></a><a href="#"><span>&#8677;</span></a>'
		
		var parent = document.getElementById(parentId)
		var attrId = document.createAttribute("id")
		attrId.value = "results-page-controls"
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement('DIV'))
		HTMLfragment.childNodes[0].setAttributeNode(attrId)
		
		HTMLfragment.childNodes[0].innerHTML = textFragment
		parent.appendChild(HTMLfragment)
	}

	KrakenSearchApp.prototype.buildResultsListTemplate = function(parentId){
		var parent = document.getElementById(parentId)
		var attrId = document.createAttribute("id")
		attrId.value = "results-list"
		var HTMLfragment = document.createDocumentFragment();
		HTMLfragment.appendChild(document.createElement('UL'))
		HTMLfragment.childNodes[0].setAttributeNode(attrId)
		
		parent.appendChild(HTMLfragment)
	}

	AsyncModule = function(){
		var xhr = new XMLHttpRequest()

		function STUBload(url, options){
			if(options.callback){
				options.arguments ? options.arguments.push(STUBDATA) : null
				options.callback.apply(options.scope, options.arguments)
			}
		}

		function get(url){
			xhr.open('get', url)
			 
			xhr.onreadystatechange = function(){
			    if(xhr.readyState === 4){
			        if(xhr.status === 200){
			        	return xhr.responseText
			        } else {
			            alert('Error: '+ xhr.status)
			        }
			    }
			}
			 
			xhr.send(null)	
		}

		function load(url, options){
			xhr.open('get', url)
			 
			xhr.onreadystatechange = function(){
			    if(xhr.readyState === 4){
			        if(xhr.status === 200){
			        	if(options.callback){
							options.arguments ? options.arguments.push(JSON.parse(xhr.responseText)) : null
							options.callback.apply(options.scope, options.arguments)
						}
			        	return JSON.parse(xhr.responseText)
			        } else {
			            alert('Error: '+ xhr.status)
			        }
			    }
			}
			 
			xhr.send(null)				
		}

		return {
			load: STUBload,
			get: get
		}
	}
	
	window.onload = function(){
		// new KrakenSearchApp('wrapper')
		app = new KrakenSearchApp('wrapper')
	}

//http://character-code.com/arrows-html-codes.php
</script>
<body id="root">
 <div id="wrapper">
 	
 </div>
</body>
</html>